<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INC Directory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Style the scraped MDL content to look clean in our UI */
        .scraped-content h2,
        .scraped-content h3 {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: #1e40af;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .scraped-content .mdl-list__item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .scraped-content .mdl-list__item-primary-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Hide MDL specific icons that might not load correctly */
        .scraped-content .material-icons {
            font-size: 18px;
            color: #94a3b8;
        }

        /* Contact info styling */
        .scraped-content .inc-contact-info h6 {
            font-size: 0.875rem;
            font-weight: 700;
            margin: 12px 0 4px 0;
            color: #475569;
        }

        /* ðŸŸ¢ INC SPECIFIC STYLES FOR SCRAPED CONTENT */
        .scraped-content .daygroup {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .scraped-content .daygroup h6 {
            font-weight: 800;
            color: #1e40af;
            text-transform: uppercase;
            font-size: 0.75rem;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .scraped-content .chip-break {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .scraped-content .chip {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #334155;
        }

        .scraped-content .subchip {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .scraped-content .ENGLISH {
            background-color: #3b82f6;
            color: white;
        }

        .scraped-content .CWS {
            background-color: #f97316;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 font-sans">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header
            class="flex justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-blue-900 uppercase tracking-tighter">INC Directory</h1>
                <p class="text-slate-500 text-sm">Automated Scraping Interface</p>
            </div>
            <div id="connection-status"
                class="text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700 border border-green-200">
                Backend Connected: 5001
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[800px]">

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-slate-600">
                    <div class="flex justify-between items-center mb-2">
                        <span>1. DISTRICTS</span>
                        <button onclick="fetchDistricts()" class="text-xs text-blue-600 hover:underline">Reload</button>
                    </div>
                    <input type="text" id="district-search" placeholder="Search districts..."
                        class="w-full px-3 py-2 text-sm font-normal border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeyup="filterDistricts()">
                </div>
                <div id="district-list" class="overflow-y-auto p-2 space-y-1 flex-grow">
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-slate-600">
                    <span id="locale-title" class="block mb-2">2. LOCALES</span>
                    <input type="text" id="locale-search" placeholder="Search congregations..."
                        class="w-full px-3 py-2 text-sm font-normal border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        onkeyup="filterLocales()">
                </div>
                <div id="locale-list" class="overflow-y-auto p-2 space-y-1 flex-grow text-slate-400 italic p-4">
                    Select a district to view congregations.
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-slate-600">
                    <span>3. WORSHIP SCHEDULES</span>
                </div>
                <div id="details-container" class="overflow-y-auto p-6 flex-grow">
                    <div class="text-slate-400 italic">Select a congregation to fetch live schedule.</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5001/api";
        const DIRECTORY_BASE = "https://directory.iglesianicristo.net";

        let allDistricts = [];
        let allLocales = [];

        // Fetch Districts (Initial Load)
        async function fetchDistricts() {
            const list = document.getElementById('district-list');
            list.innerHTML = `<div class="p-4 flex justify-center"><div class="custom-loader"></div></div>`;

            try {
                // Use local backend proxy instead of allorigins
                const response = await fetch(`${API_BASE}/districts`);
                if (!response.ok) throw new Error("Backend proxy failed to fetch districts.");

                const html = await response.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('.mdl-list_item a.weight-700');

                allDistricts = Array.from(links).map(link => ({
                    name: link.textContent.trim(),
                    path: link.getAttribute('href')
                }));

                renderDistricts(allDistricts);
            } catch (e) {
                list.innerHTML = `<p class="text-red-500 p-4">Error: ${e.message}</p>`;
            }
        }

        function renderDistricts(districts) {
            const list = document.getElementById('district-list');
            list.innerHTML = "";
            districts.forEach(district => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded-lg text-sm hover:bg-blue-50 border-b border-gray-50 transition-colors";
                btn.innerHTML = `<strong>${district.name}</strong>`;
                btn.onclick = () => fetchLocales(district.path, district.name);
                list.appendChild(btn);
            });
            if (districts.length === 0) {
                list.innerHTML = `<p class="text-slate-400 italic p-4 text-center">No districts found.</p>`;
            }
        }

        function filterDistricts() {
            const query = document.getElementById('district-search').value.toLowerCase();
            const filtered = allDistricts.filter(d => d.name.toLowerCase().includes(query));
            renderDistricts(filtered);
        }

        // Fetch Locales based on District path
        async function fetchLocales(path, districtName) {
            document.getElementById('locale-title').innerText = `LOCALES: ${districtName}`;
            document.getElementById('locale-search').value = ""; // Clear locale search on new district
            const list = document.getElementById('locale-list');
            list.innerHTML = `<div class="p-4 flex justify-center"><div class="custom-loader"></div></div>`;

            try {
                // Use local backend proxy instead of allorigins
                const response = await fetch(`${API_BASE}/locales?path=${encodeURIComponent(path)}`);
                if (!response.ok) throw new Error("Backend proxy failed to fetch locales.");

                const html = await response.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('.mdl-grid a[href*="/locales/"]');

                allLocales = Array.from(links).map(link => ({
                    name: link.textContent.trim(),
                    slug: link.getAttribute('href').split('/').pop()
                }));

                renderLocales(allLocales);
            } catch (e) {
                list.innerHTML = `<p class="text-red-500 p-4">Error loading locales.</p>`;
            }
        }

        function renderLocales(locales) {
            const list = document.getElementById('locale-list');
            list.innerHTML = "";
            locales.forEach(locale => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded-lg text-sm hover:bg-emerald-50 border-b border-gray-50";
                btn.textContent = locale.name;
                btn.onclick = () => fetchSchedule(locale.slug, locale.name);
                list.appendChild(btn);
            });
            if (locales.length === 0) {
                list.innerHTML = `<p class="text-slate-400 italic p-4 text-center">No locales found.</p>`;
            }
        }

        function filterLocales() {
            const query = document.getElementById('locale-search').value.toLowerCase();
            const filtered = allLocales.filter(l => l.name.toLowerCase().includes(query));
            renderLocales(filtered);
        }

        // FETCH LIVE DATA FROM YOUR SCRAPER.JS
        async function fetchSchedule(slug, name) {
            const container = document.getElementById('details-container');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="custom-loader mb-4"></div>
                    <p class="text-blue-900 font-bold animate-pulse">Puppeteer is scraping ${name}...</p>
                    <p class="text-xs text-slate-400 mt-2 text-center">This may take up to 30s as the browser launches.</p>
                </div>`;

            try {
                const response = await fetch(`${API_BASE}/scrape/${slug}`);
                if (!response.ok) throw new Error("Scraper returned an error.");

                const data = await response.json();

                container.innerHTML = `
                    <div class="mb-4 flex justify-between items-center">
                        <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded uppercase font-bold tracking-widest">Live Scraped Data</span>
                        <a href="${DIRECTORY_BASE}/locales/${slug}" target="_blank" class="text-[10px] text-blue-600 hover:underline">View Original Page</a>
                    </div>
                    
                    <h2 class="text-2xl font-black mb-6 text-slate-800 border-b pb-4">${name}</h2>
                    
                    <div class="space-y-8">
                        <!-- ADDRESS SECTION -->
                        <div class="bg-slate-50 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden">
                             <div class="p-4">
                                 <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">Physical Address</h3>
                                 <p class="text-slate-700 font-medium mb-4">${data.address || "Address not available."}</p>
                                 
                                 ${data.navigateUrl ? `
                                     <a href="${data.navigateUrl}" target="_blank" 
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors shadow-sm">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                         </svg>
                                         Navigate to Locale
                                     </a>
                                 ` : ''}
                             </div>

                             ${data.mapUrl ? `
                                 <div class="h-48 w-full border-t border-slate-100 bg-slate-200">
                                     <iframe width="100%" height="100%" frameborder="0" style="border:0" 
                                             src="${data.mapUrl}" allowfullscreen></iframe>
                                 </div>
                             ` : ''}
                        </div>

                        <!-- SCHEDULE SECTION -->
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative">
                             <h3 class="text-xs font-bold text-blue-500 uppercase mb-4 tracking-widest">Worship Services</h3>
                             <div class="scraped-content prose prose-slate max-w-none text-sm">
                                 ${data.schedule || "<p class='text-slate-400 italic'>Schedule not found.</p>"}
                             </div>
                        </div>

                        <!-- CONTACT SECTION -->
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                             <h3 class="text-xs font-bold text-indigo-400 uppercase mb-3 tracking-widest">Contact Information</h3>
                             <div class="text-slate-700 text-sm">
                                 ${data.contact || "<p class='text-slate-400 italic font-normal'>No contact info available.</p>"}
                             </div>
                        </div>
                    </div>

                    <div class="mt-12 pt-4 border-t border-slate-100 text-[10px] text-slate-400 flex justify-between">
                        <span>Extracted via Puppeteer (Port 5001)</span>
                        <span>Slug: ${slug}</span>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg text-red-700">
                        <p class="font-bold">Scraping Failed</p>
                        <p class="text-sm">${e.message}</p>
                        <button onclick="fetchSchedule('${slug}', '${name}')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded text-xs">Retry</button>
                    </div>`;
            }
        }

        // Start
        fetchDistricts();
    </script>
</body>

</html>